<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>압력 센서 실시간 모니터</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .control-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        .data-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        .export-section {
            margin-top: 20px;
            text-align: center;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔬 압력 센서 실시간 모니터</h1>
        
        <div class="info-box">
            <strong>사용 방법:</strong> 아두이노를 USB로 연결한 후 '연결' 버튼을 클릭하세요. 
            Chrome 또는 Edge 브라우저에서만 작동합니다.
        </div>

        <div class="control-panel">
            <button id="connectBtn" onclick="toggleConnection()">🔌 연결</button>
            <div id="status" class="status disconnected">연결 안됨</div>
            <label>
                측정 주기(ms): 
                <input type="number" id="interval" value="100" min="50" max="5000">
            </label>
            <button onclick="clearData()">📊 데이터 초기화</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>현재 압력</h3>
                <div class="value" id="currentValue">-</div>
                <small>단위: kPa</small>
            </div>
            <div class="stat-card">
                <h3>평균 압력</h3>
                <div class="value" id="avgValue">-</div>
                <small>단위: kPa</small>
            </div>
            <div class="stat-card">
                <h3>최대 압력</h3>
                <div class="value" id="maxValue">-</div>
                <small>단위: kPa</small>
            </div>
            <div class="stat-card">
                <h3>최소 압력</h3>
                <div class="value" id="minValue">-</div>
                <small>단위: kPa</small>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>

        <h3>📋 측정 데이터</h3>
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>시간</th>
                        <th>압력 (kPa)</th>
                        <th>변화량</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                </tbody>
            </table>
        </div>

        <div class="export-section">
            <button onclick="exportData()">💾 데이터 내보내기 (CSV)</button>
        </div>
    </div>

    <script>
        let port = null;
        let reader = null;
        let isConnected = false;
        let allData = [];
        let buffer = '';

        // Chart.js 설정
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '압력 (kPa)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '실시간 압력 변화'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '시간'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '압력 (kPa)'
                        },
                        beginAtZero: true
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        async function toggleConnection() {
            if (!isConnected) {
                await connectSerial();
            } else {
                await disconnectSerial();
            }
        }

        async function connectSerial() {
            try {
                // 시리얼 포트 요청
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });

                // 상태 업데이트
                isConnected = true;
                updateConnectionStatus();

                // 데이터 읽기 시작
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                // 읽기 루프
                readData();
            } catch (error) {
                console.error('연결 실패:', error);
                alert('연결 실패: ' + error.message);
            }
        }

        async function readData() {
            try {
                while (isConnected) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // 버퍼에 추가
                    buffer += value;
                    
                    // 줄바꿈으로 분리
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed) {
                            processData(trimmed);
                        }
                    }
                }
            } catch (error) {
                console.error('읽기 오류:', error);
            }
        }

        function processData(data) {
            // 숫자 추출 (다양한 형식 지원)
            const match = data.match(/[-+]?([0-9]*\.)?[0-9]+/);
            if (match) {
                const pressure = parseFloat(match[0]);
                if (!isNaN(pressure)) {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ko-KR');
                    
                    // 데이터 저장
                    const dataPoint = {
                        time: timeStr,
                        timestamp: now.getTime(),
                        pressure: pressure
                    };
                    allData.push(dataPoint);
                    
                    // UI 업데이트
                    updateUI(dataPoint);
                    
                    // 차트 업데이트
                    updateChart(timeStr, pressure);
                }
            }
        }

        function updateUI(dataPoint) {
            // 현재값 업데이트
            document.getElementById('currentValue').textContent = dataPoint.pressure.toFixed(2);
            
            // 통계 계산
            const pressures = allData.map(d => d.pressure);
            const avg = pressures.reduce((a, b) => a + b, 0) / pressures.length;
            const max = Math.max(...pressures);
            const min = Math.min(...pressures);
            
            document.getElementById('avgValue').textContent = avg.toFixed(2);
            document.getElementById('maxValue').textContent = max.toFixed(2);
            document.getElementById('minValue').textContent = min.toFixed(2);
            
            // 테이블에 추가
            const tbody = document.getElementById('dataTable');
            const row = tbody.insertRow(0);
            
            const prevPressure = allData.length > 1 ? allData[allData.length - 2].pressure : dataPoint.pressure;
            const change = dataPoint.pressure - prevPressure;
            
            row.innerHTML = `
                <td>${dataPoint.time}</td>
                <td>${dataPoint.pressure.toFixed(2)}</td>
                <td>${change >= 0 ? '+' : ''}${change.toFixed(2)}</td>
            `;
            
            // 테이블 행 수 제한
            while (tbody.rows.length > 100) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }

        function updateChart(time, pressure) {
            const maxPoints = 50;
            
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(pressure);
            
            // 데이터 포인트 제한
            if (chart.data.labels.length > maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update('none');
        }

        async function disconnectSerial() {
            isConnected = false;
            if (reader) {
                await reader.cancel();
                reader = null;
            }
            if (port) {
                await port.close();
                port = null;
            }
            updateConnectionStatus();
        }

        function updateConnectionStatus() {
            const btn = document.getElementById('connectBtn');
            const status = document.getElementById('status');
            
            if (isConnected) {
                btn.textContent = '🔴 연결 해제';
                status.textContent = '연결됨';
                status.className = 'status connected';
            } else {
                btn.textContent = '🔌 연결';
                status.textContent = '연결 안됨';
                status.className = 'status disconnected';
            }
        }

        function clearData() {
            if (confirm('모든 데이터를 삭제하시겠습니까?')) {
                allData = [];
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
                document.getElementById('dataTable').innerHTML = '';
                document.getElementById('currentValue').textContent = '-';
                document.getElementById('avgValue').textContent = '-';
                document.getElementById('maxValue').textContent = '-';
                document.getElementById('minValue').textContent = '-';
            }
        }

        function exportData() {
            if (allData.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            let csv = '시간,타임스탬프,압력(kPa)\n';
            allData.forEach(d => {
                csv += `${d.time},${d.timestamp},${d.pressure}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `압력센서_데이터_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // 브라우저 지원 확인
        if (!('serial' in navigator)) {
            document.querySelector('.info-box').innerHTML = 
                '<strong>⚠️ 브라우저 호환성 경고:</strong> 이 브라우저는 Web Serial API를 지원하지 않습니다. ' +
                'Chrome 또는 Edge 브라우저를 사용해주세요.';
            document.getElementById('connectBtn').disabled = true;
        }
    </script>
</body>
</html>
