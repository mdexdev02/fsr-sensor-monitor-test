<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì••ë ¥ ì„¼ì„œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .control-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        .data-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        .export-section {
            margin-top: 20px;
            text-align: center;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ ì••ë ¥ ì„¼ì„œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h1>
        
        <div class="info-box">
            <strong>ì‚¬ìš© ë°©ë²•:</strong> ì•„ë‘ì´ë…¸ë¥¼ USBë¡œ ì—°ê²°í•œ í›„ 'ì—°ê²°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”. 
            Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.
        </div>

        <div class="control-panel">
            <button id="connectBtn" onclick="toggleConnection()">ğŸ”Œ ì—°ê²°</button>
            <div id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
            <label>
                ì¸¡ì • ì£¼ê¸°(ms): 
                <input type="number" id="interval" value="100" min="50" max="5000">
            </label>
            <button onclick="clearData()">ğŸ“Š ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>í˜„ì¬ ì••ë ¥</h3>
                <div class="value" id="currentValue">-</div>
                <small>ë‹¨ìœ„: kPa</small>
            </div>
            <div class="stat-card">
                <h3>í‰ê·  ì••ë ¥</h3>
                <div class="value" id="avgValue">-</div>
                <small>ë‹¨ìœ„: kPa</small>
            </div>
            <div class="stat-card">
                <h3>ìµœëŒ€ ì••ë ¥</h3>
                <div class="value" id="maxValue">-</div>
                <small>ë‹¨ìœ„: kPa</small>
            </div>
            <div class="stat-card">
                <h3>ìµœì†Œ ì••ë ¥</h3>
                <div class="value" id="minValue">-</div>
                <small>ë‹¨ìœ„: kPa</small>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>

        <h3>ğŸ“‹ ì¸¡ì • ë°ì´í„°</h3>
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>ì••ë ¥ (kPa)</th>
                        <th>ë³€í™”ëŸ‰</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                </tbody>
            </table>
        </div>

        <div class="export-section">
            <button onclick="exportData()">ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (CSV)</button>
        </div>
    </div>

    <script>
        let port = null;
        let reader = null;
        let isConnected = false;
        let allData = [];
        let buffer = '';

        // Chart.js ì„¤ì •
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ì••ë ¥ (kPa)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'ì‹¤ì‹œê°„ ì••ë ¥ ë³€í™”'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'ì‹œê°„'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'ì••ë ¥ (kPa)'
                        },
                        beginAtZero: true
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        async function toggleConnection() {
            if (!isConnected) {
                await connectSerial();
            } else {
                await disconnectSerial();
            }
        }

        async function connectSerial() {
            try {
                // ì‹œë¦¬ì–¼ í¬íŠ¸ ìš”ì²­
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                isConnected = true;
                updateConnectionStatus();

                // ë°ì´í„° ì½ê¸° ì‹œì‘
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                // ì½ê¸° ë£¨í”„
                readData();
            } catch (error) {
                console.error('ì—°ê²° ì‹¤íŒ¨:', error);
                alert('ì—°ê²° ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function readData() {
            try {
                while (isConnected) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // ë²„í¼ì— ì¶”ê°€
                    buffer += value;
                    
                    // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed) {
                            processData(trimmed);
                        }
                    }
                }
            } catch (error) {
                console.error('ì½ê¸° ì˜¤ë¥˜:', error);
            }
        }

        function processData(data) {
            // ìˆ«ì ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
            const match = data.match(/[-+]?([0-9]*\.)?[0-9]+/);
            if (match) {
                const pressure = parseFloat(match[0]);
                if (!isNaN(pressure)) {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ko-KR');
                    
                    // ë°ì´í„° ì €ì¥
                    const dataPoint = {
                        time: timeStr,
                        timestamp: now.getTime(),
                        pressure: pressure
                    };
                    allData.push(dataPoint);
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateUI(dataPoint);
                    
                    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                    updateChart(timeStr, pressure);
                }
            }
        }

        function updateUI(dataPoint) {
            // í˜„ì¬ê°’ ì—…ë°ì´íŠ¸
            document.getElementById('currentValue').textContent = dataPoint.pressure.toFixed(2);
            
            // í†µê³„ ê³„ì‚°
            const pressures = allData.map(d => d.pressure);
            const avg = pressures.reduce((a, b) => a + b, 0) / pressures.length;
            const max = Math.max(...pressures);
            const min = Math.min(...pressures);
            
            document.getElementById('avgValue').textContent = avg.toFixed(2);
            document.getElementById('maxValue').textContent = max.toFixed(2);
            document.getElementById('minValue').textContent = min.toFixed(2);
            
            // í…Œì´ë¸”ì— ì¶”ê°€
            const tbody = document.getElementById('dataTable');
            const row = tbody.insertRow(0);
            
            const prevPressure = allData.length > 1 ? allData[allData.length - 2].pressure : dataPoint.pressure;
            const change = dataPoint.pressure - prevPressure;
            
            row.innerHTML = `
                <td>${dataPoint.time}</td>
                <td>${dataPoint.pressure.toFixed(2)}</td>
                <td>${change >= 0 ? '+' : ''}${change.toFixed(2)}</td>
            `;
            
            // í…Œì´ë¸” í–‰ ìˆ˜ ì œí•œ
            while (tbody.rows.length > 100) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }

        function updateChart(time, pressure) {
            const maxPoints = 50;
            
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(pressure);
            
            // ë°ì´í„° í¬ì¸íŠ¸ ì œí•œ
            if (chart.data.labels.length > maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update('none');
        }

        async function disconnectSerial() {
            isConnected = false;
            if (reader) {
                await reader.cancel();
                reader = null;
            }
            if (port) {
                await port.close();
                port = null;
            }
            updateConnectionStatus();
        }

        function updateConnectionStatus() {
            const btn = document.getElementById('connectBtn');
            const status = document.getElementById('status');
            
            if (isConnected) {
                btn.textContent = 'ğŸ”´ ì—°ê²° í•´ì œ';
                status.textContent = 'ì—°ê²°ë¨';
                status.className = 'status connected';
            } else {
                btn.textContent = 'ğŸ”Œ ì—°ê²°';
                status.textContent = 'ì—°ê²° ì•ˆë¨';
                status.className = 'status disconnected';
            }
        }

        function clearData() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                allData = [];
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
                document.getElementById('dataTable').innerHTML = '';
                document.getElementById('currentValue').textContent = '-';
                document.getElementById('avgValue').textContent = '-';
                document.getElementById('maxValue').textContent = '-';
                document.getElementById('minValue').textContent = '-';
            }
        }

        function exportData() {
            if (allData.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let csv = 'ì‹œê°„,íƒ€ì„ìŠ¤íƒ¬í”„,ì••ë ¥(kPa)\n';
            allData.forEach(d => {
                csv += `${d.time},${d.timestamp},${d.pressure}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì••ë ¥ì„¼ì„œ_ë°ì´í„°_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
        if (!('serial' in navigator)) {
            document.querySelector('.info-box').innerHTML = 
                '<strong>âš ï¸ ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê²½ê³ :</strong> ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ' +
                'Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
            document.getElementById('connectBtn').disabled = true;
        }
    </script>
</body>
</html>
